;define(function(require,exports){'use strict';var $=require('jquery'),o=require('underscore'),y=require('backbone'),j=require('core/models/components'),A=require('core/models/globals'),W=require('core/models/navigation'),G=require('core/models/options'),g=require('core/models/items'),x=require('core/models/comments'),D=require('core/models/custom-page'),i=require('root/config'),r=require('core/app-utils'),s=require('core/lib/hooks'),u=require('core/stats'),I=require('core/app-dynamic-data'),E=require('core/addons-internal'),h=require('core/lib/encryption/token'),w=require('core/modules/deep-link'),e={};var p=o.extend({},y.Events);e.on=function(e,t){p.on(e,t)};e.triggerError=function(e,t,n){p.trigger('error:'+e,t);r.log('App error event ['+e+']'+(t.hasOwnProperty('message')?' '+t.message:''),t);if(n!=undefined){t=o.extend({event:'error:'+e,id:e},t);n(t)}};e.triggerInfo=function(e,t,n){switch(e){case'no-content':p.trigger('info:no-content');break;case'app-launched':var r=u.getStats();p.trigger('info:app-ready',{stats:r});if(r.count_open==1){p.trigger('info:app-first-launch',{stats:r})};if(r.version_diff.diff!=0){p.trigger('info:app-version-changed',{stats:r})};break;default:p.trigger('info:'+e,t);if(n!=undefined){t=o.extend({event:'info:'+e,id:e},t);n(t)};break}};var F=null,d={};e.getCurrentCustomPage=function(){return F};e.showCustomPage=function(t,n,o,r){var a={template:t,data:n};if(o!==undefined){a.id=o};F=new D(a);if(r===!0){e.router.execute_route_silently(e.getScreenFragment('custom-page'));e.router.navigate(o,{trigger:!1})}else{e.router.navigate(e.getScreenFragment('custom-page'),{trigger:!0})}};e.addCustomRoute=function(e,t,n){e=r.removeTrailingSlash(e);d[e]={template:t,data:n}};e.removeCustomRoute=function(e){e=r.removeTrailingSlash(e);if(d.hasOwnProperty(e)){delete d[e]}};e.getCustomRoute=function(e){var t={};e=r.removeTrailingSlash(e);if(d.hasOwnProperty(e)){t=d[e]};return t};var v={'refresh-at-app-launch':!0,'go-to-default-route-after-refresh':!0,'custom-screen-rendering':!1,'use-html5-pushstate':!1};e.getParam=function(e){var t=null;if(v.hasOwnProperty(e)){t=v[e]};return t};e.setParam=function(e,t){if(v.hasOwnProperty(e)){v[e]=t}};e.router=null;e.silentlyAddRouteToAppHistory=function(t){var n=e.router.getRouteTypeAndParameters(t);if(n){var o=e.router.getRouteData(n.type,n.parameters);e.setQueriedScreen(o.screen_data);e.addQueriedScreenToHistory();r.log('Silently added route to history: '+t)}};e.resetDefaultRoute=function(t){var n='',t=t!==undefined&&t===!0;if(e.navigation.length>0){var a=e.navigation.first().get('component_id');n=e.getScreenFragment('component',{component_id:a})}else{if(e.components.length){var o=e.components.first();n=e.getScreenFragment('component',{component_id:o.id})}else{r.log('No menu item, no component found. Could not set default route.')}};n=s.applyFilters('default-route',n,[u.getStats(),t]);if(n!=''){e.router.setDefaultRoute(n)};return n};var C=!1;e.setIsLaunching=function(e){C=e};e.isLaunching=function(){return C};e.launchRouting=function(){var o=e.resetDefaultRoute(!0),n=o,p=w.getLaunchRoute(),g=window.location.hash,a=window.location.pathname,t='',l=!1;if(p.length>0){l=!0;t=p;e.setParam('refresh-at-app-launch',!1)}else if(g.length>0){t=g;e.setParam('refresh-at-app-launch',!1)}else if(e.getParam('use-html5-pushstate')&&a.length>0&&a.indexOf(i.app_path)===0){t=a.replace(i.app_path,'');if(t.length>0){t=r.addTrailingSlash(t);if(t!==o){e.setParam('refresh-at-app-launch',!1)}}};if(t.length>0&&t!==n){var c=s.applyFilters('add-default-route-before-asked-route',!0,[t,o,n]);if(c){e.silentlyAddRouteToAppHistory(o)};n=t};n=s.applyFilters('launch-route',n,[u.getStats()]);s.doActions('pre-start-router',[n,u.getStats()]).done(function(){w.reset();var t={};if(e.getParam('use-html5-pushstate')){t.pushState=!0;t.root=i.app_path};if(l){t.silent=!0};if(n.length>0&&o.length>0){y.history.start(t);if(n===o){e.router.default_route()}else if(l){e.router.navigate(n,{trigger:!0})}}else{t.silent=!0;y.history.start(t);e.router.navigate('#wpak-none',{trigger:!0})}})};e.getScreenFragment=function(t,n){var o='',r=e.getParam('use-html5-pushstate')?'':'#',a=e.getParam('use-html5-pushstate')?'/':'';switch(t){case'single':o=r+'single/'+n.global+'/'+n.item_id+a;break;case'page':o=r+'page/'+n.component_id+'/'+n.item_id+a;break;case'comments':o=r+'comments-'+n.item_id+a;break;case'component':var s=e.getComponentData(n.component_id);if(s){o=s.type!=='page'?r+'component-'+s.id+a:r+'page/'+s.id+'/'+s.data.root_id+a};break;case'custom-page':o=r+'custom-page'+a;break};return o};var l=[],a={};var O={};var k='',b=function(e){l.push(e)},P=function(e){return{screen_type:e.screen_type,component_id:e.component_id,item_id:e.item_id,fragment:e.fragment,data:e.hasOwnProperty('data')?e.data:{},global:e.hasOwnProperty('global')?e.global:'',label:e.hasOwnProperty('label')?e.label:''}};e.setQueriedScreen=function(e){e=o.extend(e,{fragment:y.history.fragment});e=s.applyFilters('queried-screen',e,[]);a=P(e)};e.getQueriedScreen=function(){return a};e.addQueriedScreenToHistory=function(t){var c=t!=undefined&&t==!0,o=e.getCurrentScreenData(),r=e.getPreviousScreenData();O=o;if(o.screen_type!=a.screen_type||o.component_id!=a.component_id||o.item_id!=a.item_id||o.fragment!=a.current_fragment){if(c){l=[]};var n='';if(a.fragment==o.fragment){n='none'}else if(a.screen_type=='list'){n='empty-then-push'}else if(a.screen_type=='single'){n='push';if(o.screen_type=='comments'){if(r.screen_type=='single'&&r.item_id==a.item_id){n='pop'}else{n='empty-then-push'}}}else if(a.screen_type=='page'){if(o.screen_type=='page'&&o.component_id==a.component_id&&!a.data.is_tree_root){if(r.screen_type=='page'&&r.component_id==a.component_id&&r.item_id==a.item_id){n='pop'}else{n='push'}}else if(o.screen_type=='comments'){if(r.screen_type=='page'&&r.item_id==a.item_id){n='pop'}else{n='empty-then-push'}}else{n='empty-then-push'}}else if(a.screen_type=='comments'){if((o.screen_type=='single'||o.screen_type=='page')&&o.item_id==a.item_id){n='push'}else{var p='posts',i=e.getGlobalItem('posts',a.item_id);if(!i){i=e.getGlobalItem('pages',a.item_id);if(i){p='pages'}};if(i){var g={screen_type:p==='posts'?'single':'page',component_id:'',item_id:a.item_id,global:p,data:{post:i},label:i.title,fragment:p==='posts'?e.getScreenFragment('single',{global:'posts',item_id:a.item_id}):''};b(P(g));n='push'}}}else if(a.screen_type=='custom-page'){n='empty-then-push'}else if(a.screen_type=='custom-component'){n='empty-then-push'}else{n='empty'}};n=s.applyFilters('make-history',n,[l,a,o,r]);k=n;switch(n){case'empty-then-push':l=[];b(a);break;case'empty':l=[];break;case'push':b(a);break;case'pop':l.pop();break}};e.getHistory=function(){return l.slice(0)};e.getLastHistoryAction=function(){return k};e.getCurrentScreenData=function(){var e={};if(l.length){e=l[l.length-1]};return e};e.getPreviousScreenData=function(){var e={};if(l.length>1){e=l[l.length-2]};return e};e.getPreviousScreenMemoryData=function(){return O};e.getPreviousScreenLink=function(){var t='',n=e.getPreviousScreenData();if(!o.isEmpty(n)){t='#'+n.fragment};return t};e.getCurrentScreenGlobal=function(t){var o=e.getCurrentScreenData(),n='';if(t!=undefined){n=t}else{if(o.screen_type=='comments'){var r=e.getPreviousScreenData();if(r.screen_type=='single'){n=r.global}}else{if(o.hasOwnProperty('global')&&o.global!=''){n=o.global}}};n=s.applyFilters('current-screen-global',n,[o,t]);return n};e.components=new j;e.navigation=new W;e.options=new G;e.comments=new x.CommentsMemory;var c=new A;e.globals={};e.addGlobalType=function(t){if(undefined===c.get(t)){r.log('app.addGlobalType info: adding a type to globals',{type:t});c.add({id:t});e.globals[t]=new g.Items([],{global:t})}};e.addGlobalItem=function(t,n){if(undefined===n.id){r.log('app.addGlobalItem error: undefined item.id',{item:n});return};if(undefined===c.get(t)){r.log('app.addGlobalItem info: '+t+' not known, adding it',{type:t,item:n});e.addGlobalType(t)};if(null===e.getGlobalItem(t,n.id)){r.log('app.addGlobalItem info: adding an item to globals',{type:t,item:n});e.globals[t].add(n)}};e.componentExists=function(t){return e.components.get(t)!==undefined};e.getComponents=function(t){var n=[];if(o.isObject(t)){if(t.type){n=e.components.where({type:t.type})}}else{n=e.components.toJSON()};return n};e.getNavigationComponents=function(t){var n=[];e.navigation.each(function(o){var r=e.components.get(o.get('component_id'));if(r){if(t.type){if(r.get('type')==t.type){n.push(r)}}else{n.push(r)}}});return n};e.sync=function(t,n,o){var a=o!=undefined&&o;e.components.fetch({'success':function(o,i,l){s.doActions('components-fetched',[o,i,l]).done(function(){if(o.length==0||a){f(t,n)}else{r.log('Components retrieved from local storage.',{components:o});e.navigation.fetch({'success':function(o,a,s){if(o.length==0){f(t,n)}else{r.log('Menu items retrieved from local storage.',{navigation:o});c.fetch({'success':function(o,a,s){if(o.length==0){f(t,n)}else{var l=function(t,n){return t.fetch({'success':function(t,o,r){e.globals[n]=t}})},i=[];o.each(function(e,t,n){var o=e.get('id'),r=new g.Items([],{global:o});i.push(l(r,o))});$.when.apply($,i).done(function(){if(e.globals.length==0){f(t,n)}else{r.log('Global items retrieved from local storage.',{globals:e.globals});t()}})}}})}}})}})}})};var f=function(t,n){if(e.isLaunching()){e.setParam('refresh-at-app-launch',!1)};p.trigger('refresh:start');var d=$.Deferred(),b=function(){t(d)},l=function(e){n(e,d)};d.always(function(e){p.trigger('refresh:end',e)});var v=h.getWebServiceUrlToken('synchronization'),f=v+'/synchronization/',y=s.applyFilters('web-service-params',{},['synchronization']);var a={timeout:40000,data:y};a=s.applyFilters('ajax-args',a,['synchronization']);a.url=i.wp_ws_url+f;a.type='GET';a.dataType='json';a.success=function(t){if(t.hasOwnProperty('result')&&t.result.hasOwnProperty('status')){if(t.result.status==1){if(t.hasOwnProperty('components')&&t.hasOwnProperty('navigation')&&t.hasOwnProperty('globals')&&t.hasOwnProperty('dynamic_data')){e.components.resetAll();o.each(t.components,function(t,n,o){e.components.add({id:n,label:t.label,type:t.type,data:t.data,global:t.global})});e.components.saveAll();e.navigation.resetAll();o.each(t.navigation,function(t,n,o){e.navigation.add({id:n,component_id:n,options:t})});e.navigation.saveAll();c.each(function(e,t,n){var o=e.get('id'),r=new g.Items([],{global:o});r.resetAll()});e.globals={};c.resetAll();o.each(t.globals,function(t,n,r){var a=new g.Items([],{global:n});a.resetAll();o.each(t,function(e,t){a.add(o.extend({id:t},e))});a.saveAll();e.globals[n]=a;c.add({id:n})});c.saveAll();e.comments.reset();u.incrementContentLastUpdate();I.setDynamicDataFromWebService(t.dynamic_data);E.setDynamicDataFromWebService(t.addons);if(t.components.length===0){e.triggerError('synchro:no-component',{type:'web-service',where:'app::syncWebService',message:'No component found for this App. Please add components to the App on WordPress side.',data:t},l)}else{r.log('Components, menu items and globals retrieved from online.',{components:e.components,navigation:e.navigation,globals:e.globals});b()}}else{e.triggerError('synchro:wrong-answer',{type:'web-service',where:'app::syncWebService',message:'Wrong "synchronization" web service answer',data:t},l)}}else if(t.result.status==0){e.triggerError('synchro:ws-return-error',{type:'web-service',where:'app::syncWebService',message:'Web service "synchronization" returned an error : ['+t.result.message+']',data:t},l)}else{e.triggerError('synchro:wrong-status',{type:'web-service',where:'app::syncWebService',message:'Wrong web service answer status',data:t},l)}}else{e.triggerError('synchro:wrong-format',{type:'web-service',where:'app::syncWebService',message:'Wrong web service answer format',data:t},l)}};a.error=function(t,n,o){e.triggerError('synchro:ajax',{type:'ajax',where:'app::syncWebService',message:n+': '+o,data:{url:i.wp_ws_url+f,jqXHR:t,textStatus:n,errorThrown:o}},l)};$.ajax(a)},q=function(t,n,r){var d=h.getWebServiceUrlToken('comments-post'),g=d+'/comments-post/'+t,p=new x.Comments,f=s.applyFilters('comments-globals',['posts','pages'],[t]),l=null,c='';f.every(function(n){l=e.globals[n].get(t);if(l!=undefined){c=n};return l===undefined});if(l!=undefined&&l!=null){var u=s.applyFilters('web-service-params',{},['get-post-comments']);var a={data:u};a=s.applyFilters('ajax-args',a,['get-post-comments']);a.url=i.wp_ws_url+g;a.type='GET';a.dataType='json';a.success=function(e){o.each(e.items,function(e,t,n){p.add(e)});l.set('nb_comments',p.length);l.save();n(p,l,c)};a.error=function(t,n,o){e.triggerError('comments:ajax',{type:'ajax',where:'app::fetchPostComments',message:n+': '+o,data:{url:i.wp_ws_url+g,jqXHR:t,textStatus:n,errorThrown:o}},r)};$.ajax(a)}else{e.triggerError('comments:post-not-found',{type:'not-found',where:'app::fetchPostComments',message:'Post '+t+' not found.'},r)}};e.getPostComments=function(t,n,o,a){a=a===!0;var s=e.comments.get(t);if(s&&!a){var i=s.get('post_comments'),l=s.get('post'),p=s.get('item_global');r.log('Comments retrieved from cache.',{comments:i,post:l,item_global:p});n(i,l,p)}else{q(t,function(o,a,s){r.log('Comments retrieved from online.',{comments:o,post:a,item_global:s});e.comments.addPostComments(t,a,s,o);n(o,a,s)},function(e){o(e)})}};e.getPostGlobal=function(t,n){var o=e.getCurrentScreenGlobal(n);return s.applyFilters('post-global',o,[t,n])};e.getMoreOfComponent=function(t,n,a,l){l=(l!==undefined)&&l===!0;var d=e.getCurrentScreenData(),v='';if(d.component_id&&e.componentExists(d.component_id)){v=d.component_id};l=s.applyFilters('use-standard-pagination',l,[v,d]);var u=e.components.get(t);if(u){var p=u.get('data');if(p.hasOwnProperty('ids')){var b=h.getWebServiceUrlToken('component'),f=b+'/component/'+t,w=o.last(p.ids),c={};if(l){var y=p.query.hasOwnProperty('pagination_page')&&p.query.pagination_page>0?parseInt(p.query.pagination_page):1;c.pagination_page=y+1}else{c.before_item=w};var c=s.applyFilters('web-service-params',c,['get-more-of-component']),g={data:c};g=s.applyFilters('ajax-args',g,['get-more-of-component']);g.url=i.wp_ws_url+f;g.type='GET';g.dataType='json';g.success=function(s){if(s.result&&s.result.status==1){if(s.component.slug==t){var i=s.component.global;if(e.globals.hasOwnProperty(i)){var g=o.difference(s.component.data.ids,p.ids);p.query.pagination_page=s.component.data.query.pagination_page;p.ids=o.union(p.ids,s.component.data.ids);u.set('data',p);var m=e.globals[i];o.each(s.globals[i],function(e,t){m.add(o.extend({id:t},e))});var l=[];o.each(g,function(e){l.push(m.get(e))});var c=p.total-p.ids.length,d=!o.isEmpty(s.component.data.query.is_last_page)?!0:c<=0;r.log('More content retrieved for component',{component_id:t,new_ids:g,new_items:l,component:u});e.triggerInfo('component:get-more',{new_items:l,is_last:d,nb_left:c,new_ids:g,global:i,component:u},n)}else{e.triggerError('getmore:global-not-found',{type:'not-found',where:'app::getMoreOfComponent',message:'Global not found : '+i},a)}}else{e.triggerError('getmore:wrong-component-id',{type:'not-found',where:'app::getMoreOfComponent',message:'Wrong component id : '+t},a)}}else{e.triggerError('getmore:ws-return-error',{type:'web-service',where:'app::getMoreOfComponent',message:'Web service "component" returned an error : ['+s.result.message+']'},a)}};g.error=function(t,n,o){e.triggerError('getmore:ajax',{type:'ajax',where:'app::getMoreOfComponent',message:n+': '+o,data:{url:i.wp_ws_url+f,jqXHR:t,textStatus:n,errorThrown:o}},a)};$.ajax(g)}}};var S=function(t,n,r,a){r=(r!==undefined)?r:'update';a=(a!==undefined)&&a===!0;var i={ok:!0,message:'',type:'',data:{}};if(r!=='update'&&r!=='replace'){i.ok=!1;i.type='bad-format';i.message='Wrong type : '+r;return i};if(!e.globals.hasOwnProperty(t)){e.globals[t]=new g.Items([],{global:t})};var s=e.globals[t],m=[];o.each(s,function(e,t){m.push(t)});if(r=='replace'){s.resetAll()};var p=[];o.each(n,function(e,t){p.push(t);s.add(o.extend({id:t},e),{merge:!0})});var l=[];if(r=='replace'){l=p}else{l=o.difference(p,m)};var c=[];o.each(l,function(e){c.push(s.get(e))});if(a){s.saveAll()};i.data={new_ids:l,new_items:c,global:t,items:s};return i},T=function(t,n,r,s){r=(r!==undefined)?r:'replace-keep-global-items';s=(s!==undefined)&&s===!0;var a={ok:!0,message:'',type:'',data:{}};if(!t.data||!t.slug){a.ok=!1;a.type='bad-format';a.message='Wrong component format';return a};if(r!=='update'&&r!=='replace'&&r!=='replace-keep-global-items'){a.ok=!1;a.type='bad-format';a.message='Wrong type : '+r;return a};var c=e.components.get(t.slug);if(c){var d=c.get('data'),l=t.data;if(l.hasOwnProperty('ids')){if(t.global){var i=t.global;if(!e.globals.hasOwnProperty(i)){var u=new g.Items([],{global:i});e.globals[i]=u};var m=[];if(r==='replace'||r==='replace-keep-global-items'){m=l.ids}else{m=o.difference(l.ids,d.ids);l.ids=o.union(d.ids,l.ids)};c.set('data',l);var p=e.globals[i];if(r==='replace'){p.resetAll()};o.each(n[i],function(e,t){p.add(o.extend({id:t},e),{merge:!0})});var f=[];o.each(m,function(e){f.push(p.get(e))});if(s){c.save();p.saveAll()};a.data={new_ids:m,new_items:f,component:c}}else{a.ok=!1;a.type='bad-format';a.message='List component must have a global'}}else{if(r=='update'){l=o.extend(d,l)}else{};c.set('data',l);if(s){c.save()};if(t.global){var i=t.global;if(!e.globals.hasOwnProperty(i)){var u=new g.Items([],{global:i});e.globals[i]=u};var p=e.globals[i];if(r=='replace'){p.resetAll()};o.each(n[i],function(e,t){p.add(o.extend({id:t},e),{merge:!0})});if(s){p.save()}};a.data={component:c}}}else{a.ok=!1;a.type='not-found';a.message='Component not found : '+t.slug};return a};e.resetGlobalItems=function(e,t){t=(t!==undefined)&&t===!0;S(e,{},'replace',t)};e.liveQuery=function(t,n,a,l){var d=!l.hasOwnProperty('auto_interpret_result')||l.auto_interpret_result===!0,g=l.hasOwnProperty('type')?l.type:'replace-keep-global-items',c=l.hasOwnProperty('persistent')&&l.persistent===!0,f=h.getWebServiceUrlToken('live-query'),u=f+'/live-query';t=s.applyFilters('web-service-params',t,['live-query']);var p={data:t};p=s.applyFilters('ajax-args',p,['live-query']);p.url=i.wp_ws_url+u;p.type='GET';p.dataType='json';p.success=function(t){if(t.result&&t.result.status==1){if(d){var l={};if(t.components){l=t.components}else if(t.component){l[t.component.slug]=t.component};if(!o.isEmpty(l)){var s='',i={};o.each(l,function(e){var n=T(e,t.globals,g,c);i[e.slug]=n;if(n.ok){r.log('Live query update component "'+e.slug+'" OK.',n)}else{r.log('Error : Live query : update_component "'+e.slug+'"',n,e);s+=(n.message+' ')}});if(s===''){if(n){n(t,i)}}else{e.triggerError('live-query:update-component-error',{type:'mixed',where:'app::liveQuery',message:s,data:{results:i}},a)}}else if(t.globals&&!o.isEmpty(t.globals)){var s='',i={};o.each(t.globals,function(e,t){var n=S(t,e,g,c);i[t]=n;if(n.ok){r.log('Live query update global "'+t+'" OK.',n)}else{r.log('Error : Live query : update_global_items "'+t+'"',n,e);s+=(n.message+' ')}});if(s===''){if(n){n(t,i)}}else{e.triggerError('live-query:update-global-items-error',{type:'mixed',where:'app::liveQuery',message:s,data:{results:i}},a)}}else{e.triggerError('live-query:no-auto-interpret-action-found',{type:'not-found',where:'app::liveQuery',message:'Live Query web service : could not auto interpret answer',data:{answer:t}},a)}}else{r.log('Live query ok (no auto interpret). Web Service answer : "',t,p);if(n){n(t)}}}else{e.triggerError('live-query:ws-return-error',{type:'web-service',where:'app::liveQuery',message:'Web service "liveQuery" returned an error : ['+t.result.message+']'},a)}};p.error=function(t,n,o){e.triggerError('live-query:ajax',{type:'ajax',where:'app::liveQuery',message:n+': '+o,data:{url:i.wp_ws_url+u,jqXHR:t,textStatus:n,errorThrown:o}},a)};$.ajax(p)};e.getPageComponentByPageId=function(e,t){var n=o.find(this.getComponents(),function(t){return t.type==='page'&&t.global==='pages'&&t.data.root_id===e});if(!n&&t===!0){n=this.findFirstComponentOfType('page')};return n};e.getComponentData=function(t){var i=null,a=e.components.get(t);if(a){var m=a.get('type');switch(m){case'posts-list':var n=a.get('data');var p=new g.ItemsSlice(),l=e.globals[a.get('global')];o.each(n.ids,function(e,t){p.add(l.get(e))});i={type:m,view_data:{posts:p,title:a.get('label'),total:n.total},data:n};break;case'page':var n=a.get('data');var d=a.get('global'),l=e.globals[d];if(l){var u=l.get(n.root_id);if(u){i={type:m,view_data:{},data:n}}};break;case'hooks':if(a.get('data')){var n=a.get('data');if(a.get('global')){var l=e.globals[a.get('global')];if(l){if(n.hasOwnProperty('ids')){var p=new g.ItemsSlice();o.each(n.ids,function(e,t){p.add(l.get(e))});var c={items:p.toJSON(),title:a.get('label')};if(n.hasOwnProperty('total')){c=o.extend(c,{total:n.total})};i={type:'hooks-list',view_data:c,data:n}}else{i={type:'hooks-no-global',view_data:n,data:n}}}else{i={type:'hooks-no-global',view_data:n,data:n}}}else{r.log('app.js warning : custom component has a global but no ids : the global will be ignored.');i={type:'hooks-no-global',view_data:n,data:n}}}else{e.triggerError('getcomponentdata:hooks:no-data',{type:'wrong-data',where:'app::getComponentData',message:'Custom component ['+t+'] has no data attribute: please check that the component\'s hook is set correctly.',data:{component:a}})};break;default:i={type:'',view_data:{},data:{}};i=s.applyFilters('component-data',i,[a]);if(i.type==''){i=null};break}};if(i!=null){i=o.extend({id:a.get('id'),label:a.get('label'),global:a.get('global')},i)};return i};e.getGlobalItems=function(t,n,r){var a=[];r=r===undefined?!1:(r===!0);if(o.has(e.globals,t)){var s=e.globals[t];if(n!==undefined&&n.length){o.each(n,function(e,t){var n=s.get(e);if(n){a.push(r?n:n.toJSON())}})}else{s.each(function(e,t){a.push(r?e:e.toJSON())})}};return a};e.getGlobalItemsSlice=function(t,n){var r=new g.ItemsSlice();if(o.has(e.globals,t)){var a=e.globals[t];if(n!==undefined&&n.length){o.each(n,function(e){r.add(a.get(e))})}else{a.each(function(e,t){r.add(e)})}};return r};e.getGlobalItem=function(t,n){var a=null;if(o.has(e.globals,t)){var s=e.globals[t],r=s.get(n);if(r){a=r.toJSON()}};return a};e.getItemsFromRemote=function(t,n){n=n||{};r.log('Retrieving items from remote server.',t);var a=null;if(n.component_id){if(this.components.get(n.component_id)){a=this.components.get(n.component_id)}else{this.triggerError('get-items:remote:wrong-component-given',{type:'wrong-data',where:'app::getItemsFromRemote',message:'Provided component not found ['+n.component_id+']',data:{options:n,items_ids:t}},n.error);return}};if(!a){var l=n.component_type?n.component_type:'posts-list';a=this.findFirstComponentOfType(l)};if(a){var s=this,i=!n.persistent||n.persistent===!0;this.liveQuery({wpak_component_slug:a.id,wpak_query_action:'get-items',wpak_items_ids:t},function(e,i){var l=o.find(i,function(e){return e.data.new_items.length>0});if(l){r.log('Items retrieved successfully from remote server.',t,i);if(n.success){n.success(e,a,i)}}else{if(n.error){s.triggerError('get-items:remote:no-item-found',{type:'not-found',where:'app::getItemsFromRemote',message:'Requested items not found',data:{options:n,items_ids:t}},n.error)}}},function(e){if(n.error){n.error(e)}},{type:'update',persistent:i})}else{e.triggerError('get-items:remote:wrong-component',{type:'wrong-data',where:'app::getItemsFromRemote',message:'Could not find a valid component',data:{options:n,items_ids:t}},n.error)}};e.findFirstComponentOfType=function(e){return o.findWhere(this.getComponents(),{type:e})};e.loadRouteItemFromRemote=function(e,t,n,o){var g=s.applyFilters('load-unfound-items-from-remote',!0,[e,t]);if(g){var a=s.applyFilters('load-unfound-items-component-id','',[e,t]),i=s.applyFilters('load-unfound-items-component-type',n,[e,t]);this.triggerInfo('load-item-from-remote:start',{item_id:e,item_global:t,item_component_id:a,item_component_type:i});var p=this.globals[t],l=this;this.getItemsFromRemote([e],{component_id:a,component_type:i,success:function(n,s,g){var c=p.get(e);l.triggerInfo('load-item-from-remote:stop',{item_id:e,item_global:t,item:c,item_component_id:a,item_component_type:i,success:!!c});if(c){if(o.success){o.success(c,s)}}else{r.log('loadRouteItemFromRemote : unexpected error "'+e+'" not found in global "'+t+'" even after remote call.');l.triggerError('get-items:remote:item-not-found-in-global',{type:'not-found',where:'app::loadRouteItemFromRemote',message:'Requested items not found',data:{item_id:e,item_global:t,item:c,item_component_id:a,item_component_type:i}});if(o.error){o.error()}}},error:function(){l.triggerInfo('load-item-from-remote:stop',{item_id:e,item_global:t,item_component_id:a,item_component_type:i,success:!1});if(o.error){o.error()}}})}else{if(o.error){o.error()}}};var R=function(t){e.options.fetch({'success':function(n,o,a){r.log('Options retrieved from local storage.',{options:n});e.saveOptions(t)},'error':function(n,o,r){e.saveOptions(t)}})};e.saveOptions=function(t){o.each(i.options,function(t,n,o){if(undefined===e.options.get(n)){r.log('Option not existing: adding to collection',{key:n,value:t});e.options.add({id:n,value:t})}});e.options.saveAll();if(undefined!==t){t()}};e.initialize=function(n){if(i.app_platform==='pwa'&&i.app_type!=='preview'){e.setParam('use-html5-pushstate',!0);r.log('HTML5 pushstate mode activated.')};document.addEventListener('resume',e.onResume,!1);R(function(){E.initialize(function(){I.initialize(function(){if(i.debug_mode=='on'){require(['core/views/debug','jquery.velocity'],function(e){var t=new e();t.render()})};if(undefined!==n){n()}})})})};e.onResume=function(){var t=w.getLaunchRoute();t=s.applyFilters('resume-route',t,[u.getStats()]);if(t.length){e.router.navigate(t,{trigger:!0})}};e.onOnline=function(){p.trigger('network:online');r.log('Network event : online')};e.onOffline=function(){p.trigger('network:offline');r.log('Network event : offline')};return e});