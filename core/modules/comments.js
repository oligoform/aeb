;define(function(require){'use strict';var $=require('jquery'),p=require('root/config'),n=require('core/lib/hooks'),u=require('core/lib/encryption/token'),r=require('core/app'),o=require('core/modules/authentication'),l=require('core/region-manager'),t=require('core/app-utils'),s={};var a=u.getWebServiceUrlToken('comments-post')+'/comments-post/',m=function(e,m,c,l){var u='comment-'+m,s={};s.action=u;s.comment=e;var g=['content','post'];s.auth=o.getActionAuthData(u,g,e);s=n.applyFilters('web-service-params',s,['comments-post']);var r={timeout:40000,data:s};r=n.applyFilters('ajax-args',r,['comments-post']);r.url=p.wp_ws_url+a;r.type=m;r.dataType='json';r.success=c;r.error=function(e,o,n){var r='ajax-failed';r+=(':'+t.getAjaxErrorType(e,o,n));l(r,{jqXHR:e,textStatus:o,errorThrown:n})};t.log('Calling comments web service',s.comment);$.ajax(r)},c=function(e,n,o){if(e.hasOwnProperty('content')){var r=e.content;e.content=btoa(unescape(encodeURIComponent(r)))}else{o('no-content');return};if(!e.hasOwnProperty('post')||!e.post){o('no-comment-post');return};t.log('Sending comment on post '+e.post+' : ',r);var s=function(r){if(r.hasOwnProperty('result')&&r.result.hasOwnProperty('status')&&r.result.hasOwnProperty('message')){if(r.result.status==1){if(r.hasOwnProperty('comment_ok')){if(r.comment_ok===1){if(r.waiting_approval===0){var a=l.getCurrentView();if(a.hasOwnProperty('update_comments')){a.update_comments(r.comments)}};var s={post_id:e.post,comment:r.comment,comments:r.comments,waiting_approval:r.waiting_approval};t.log('Comment added successfully'+(s.waiting_approval?', waiting for approval':''),s);n(s)}else if(r.hasOwnProperty('comment_error')){o(r.comment_error)}else{o('no-comment-error')}}else{o('wrong-answer-format')}}else{o('web-service-error : '+r.result.message)}}else{o('wrong-ws-data')}},a=function(e){o(e)};m(e,'POST',s,a)};s.postComment=function(e,t,n){c(e,function(e){r.triggerInfo('comment:posted',e,t)},function(e){if(e==='user-connection-expired'){o.logUserOut(2)}else if(e==='user-not-authenticated'){o.logUserOut(3)};r.triggerError('comment:'+e,{type:'comment-error',where:'comments.postComment:sendComment'},n)})};return s});