;define(function(require,exports){'use strict';var n=require('backbone'),c=require('underscore'),o=require('core/app-utils'),i=require('core/region-manager'),u=require('core/lib/hooks'),t=require('core/app'),s='',a='',l=function(e){var t=o.trimFragment(a);e=o.trimFragment(e);return t==e},p=function(e){var t=o.trimFragment(s);e=o.trimFragment(e);return e==t},g=function(e){var t='not_found';if(e==='/^(?:\?([\s\S]*))?$/'){t='default_route'}else if(e.indexOf('/^single')===0){t='single'}else if(e.indexOf('/^page')===0){t='page'}else if(e.indexOf('/^comments')===0){t='comments'}else if(e.indexOf('/^component')===0){t='component'}else if(e.indexOf('/^custom\-page')===0){t='custom-page'}else if(e==='/^([^?]*?)(?:\?([\s\S]*))?$/'){t='not_found'};return t};c.extend(n.history,{navigate:function(e,t){var i=/#.*$/;if(!n.History.started)return!1;if(!t||t===!0)t={trigger:!!t};e=this.getFragment(e||'');var r=this.root;if(e===''||e.charAt(0)==='?'){};var a=r+e;e=this.decodeFragment(e.replace(i,''));if(this.fragment===e)return;this.fragment=e;if(this._usePushState){this.history[t.replace?'replaceState':'pushState']({},document.title,a)}else if(this._wantsHashChange){this._updateHash(this.location,e,t.replace);if(this.iframe&&e!==this.getHash(this.iframe.contentWindow)){var o=this.iframe.contentWindow;if(!t.replace){o.document.open();o.document.close()};this._updateHash(o.location,e,t.replace)}}else{return this.location.assign(a)};if(t.trigger)return this.loadUrl(e)}});return n.Router.extend({routes:{'':'default_route','single/:global/:id':'single','page/:component_id/:page_id':'page','page/:page_id':'page_no_component','comments-:post_id':'comments','component-:id':'component','custom-page':'custom_page','single/:global/:id/':'single','page/:component_id/:page_id/':'page','page/:page_id/':'page_no_component','comments-:post_id/':'comments','component-:id/':'component','custom-page/':'custom_page','*notFound':'not_found'},setDefaultRoute:function(e){s=e},getDefaultRoute:function(){return s},default_route:function(){this.navigate('/',{trigger:!0});if(s.length){this.execute_route_silently(s)}},default_route_redirect:function(e){if(p(e)){this.navigate('/')}},component:function(e){a='component-'+e;this.default_route_redirect(a);var r=this.getRouteData('component',{component_id:e});if(r.error.length===0){if(l('component-'+e)){switch(r.screen_data.component_type){case'posts-list':i.show(r.view_type,r.view_data,r.screen_data);break;case'page':this.navigate(t.getScreenFragment('page',{component_id:e,item_id:r.screen_data.data.root_id}),{trigger:!0});break;case'hooks-list':case'hooks-no-global':i.show(r.view_type,r.view_data,r.screen_data);break;default:if(r.view_type!==''){i.show(r.view_type,r.view_data,r.screen_data)};break}}}else{o.log(r.error);t.router.default_route()}},single:function(e,r){a='single/'+e+'/'+r;this.default_route_redirect(a);var u=this,n=function(){var a=u.getRouteData('single',{item_global:e,item_id:r});if(a.error.length===0){if(l('single/'+e+'/'+r)){i.show(a.view_type,a.view_data,a.screen_data)}}else{o.log(a.error);t.router.default_route()}},s=t.globals[e];if(s){var c=s.get(r);if(c){n()}else{o.log('Router single route : item with id "'+r+'" not found in global "'+e+'".');t.loadRouteItemFromRemote(r,e,'posts-list',{success:function(e){n()},error:function(){t.router.default_route()}})}}else{o.log('Error : router single route : global "'+e+'" not found.');t.router.default_route()}},page:function(e,r){a='page/'+e+'/'+r;this.default_route_redirect(a);var n='pages',p=this,c=function(a){if(a==='wpak-page-component-placeholder'){var c=t.getPageComponentByPageId(s.get('id'),!0);if(c){a=c.id}};var n=p.getRouteData('page',{component_id:a,page_id:r});if(n.error.length===0){if(l('page/'+e+'/'+r)){i.show(n.view_type,n.view_data,n.screen_data)}}else{o.log(n.error);t.router.default_route()}},u=t.globals[n];if(u){var s=u.get(r);if(s){c(e)}else{o.log('Error : router : page route : item with id "'+r+'" not found in global "'+n+'".');t.loadRouteItemFromRemote(r,n,'page',{success:function(e,t){c(e,t.id)},error:function(){t.router.default_route()}})}}else{o.log('Error : router : screen route : global "'+n+'" not found.');t.router.default_route()}},page_no_component:function(e){this.page('wpak-page-component-placeholder',e)},comments:function(e){a='comments-'+e;function n(e,t,o){if(l('comments-'+t.id)){i.show('comments',{comments:e,post:t},{screen_type:'comments',component_id:'',item_id:parseInt(t.id),data:{item_global:o}})}};var r=t.comments.get(e);if(r){n(r.get('post_comments'),r.get('post'),r.get('item_global'))}else{t.getPostComments(e,function(e,t,o){n(e,t,o)},function(e){o.log('router.js error : App.getPostComments failed',e)})}},custom_page:function(){a='custom-page';var e=this.getRouteData('custom-page',{});if(e.error.length===0){if(l('custom-page')){i.show(e.view_type,e.view_data,e.screen_data)}}else{o.log(e.error);t.router.default_route()}},not_found:function(e){var o=u.applyFilters('fragment-not-found','#',[e]),a=t.getCustomRoute(e);if(!c.isEmpty(a)){o='';t.showCustomPage(a.template,a.data,e,!0)};if(o.length){this.navigate(o,{trigger:!0})}},getRouteTypeAndParameters:function(e){var t=null,r=n.history.getFragment(e),a=c.find(n.history.handlers,function(e){return e.route.test(r)});if(a){t={type:g(a.route.toString()),parameters:{}};var o=this._extractParameters(a.route,r);switch(t.type){case'default_route':t.parameters={};break;case'single':t.parameters={item_global:o[0],item_id:o[1]};break;case'page':t.parameters={component_id:o[0],page_id:o[1]};break;case'comments':t.parameters={post_id:o[0]};break;case'component':t.parameters={component_id:o[0]};break;case'custom-page':t.parameters={};break;case'not_found':t.parameters={fragment:o[0]};break}};return t},getRouteData:function(o,r){var e={view_type:'',view_data:{},screen_data:{},error:''};switch(o){case'default_route':break;case'single':var n=r.item_global;var m=r.item_id,l=t.globals[n];if(l){var s=l.get(m);if(s){var d=s.toJSON(),p=n=='posts'?{post:d}:{item:d};e.view_type='single';e.view_data={item:s,global:n};e.screen_data={screen_type:'single',component_id:'',component_type:'',item_id:parseInt(m),global:n,data:p,label:d.title}}else{e.error='Error : router single route : item with id "'+m+'" not found in global "'+n+'".'}}else{e.error='Error : router single route : global "'+n+'" not found.'};break;case'page':var i=r.component_id;var g=r.page_id,n='pages',l=t.globals[n];if(l){var s=l.get(g);if(s){var a=t.getComponentData(i);if(a){var p={post:s.toJSON(),is_tree_page:a.data.is_tree,is_tree_root:(g==a.data.root_id),root_id:a.data.root_id,root_depth:a.data.root_depth};e.view_type='page';e.view_data={item:s,global:n};e.screen_data={screen_type:'page',component_id:i,component_type:a.type,item_id:parseInt(g),global:n,data:p,label:p.post.title}}else{e.error='Error : router : page route : component with id "'+i+'" not found'}}else{e.error='Error : router : page route : item with id "'+g+'" not found in global "'+n+'".'}}else{e.error='Error : router : screen route : global "'+n+'" not found.'};break;case'comments':screen_data={};break;case'component':var i=r.component_id;var a=t.getComponentData(r.component_id);if(a){if(a.type==='posts-list'){e.view_type='posts-list';e.view_data=a.view_data;e.screen_data={screen_type:'list',component_type:a.type,component_id:i,item_id:0,global:a.global,data:a.data,label:a.label}}else if(a.type==='hooks-list'||a.type==='hooks-no-global'){e.view_type='hooks';e.view_data={component:a};e.screen_data={screen_type:'custom-component',component_type:a.type,component_id:i,item_id:0,global:a.global,data:a.data,label:a.label}}else{e=u.applyFilters('component-custom-type',e,[a])}}else{e.error='Error : component not found: "'+i+'"'};break;case'custom-page':var c=t.getCurrentCustomPage();if(c!==null){e.view_type='custom-page';e.view_data={custom_page:c};e.screen_data={screen_type:'custom-page',component_id:'',component_type:'',item_id:c.get('id'),data:{custom_page:c}}}else{e.error='Error : no current custom page found'};break;case'not_found':break};return e},execute_route_silently:function(e){var t=n.history.getFragment(e),a=c.find(n.history.handlers,function(e){return e.route.test(t)});if(a!==undefined){this.execute(a.callback,[t],'')}else{o.log('Router.js error: execute_route_silently: route not found.')}}})});